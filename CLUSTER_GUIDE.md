# Go Queue é›†ç¾¤å’Œé«˜å¯ç”¨æ€§æŒ‡å—

## ğŸ¯ æ¦‚è¿°

Go Queue ç°åœ¨æ”¯æŒåŸºäº Raft ç®—æ³•çš„é›†ç¾¤æ¨¡å¼ï¼Œæä¾›é«˜å¯ç”¨æ€§å’Œæ•°æ®ä¸€è‡´æ€§ä¿è¯ã€‚é›†ç¾¤æ¨¡å¼ä½¿ç”¨ [dragonboat](https://github.com/lni/dragonboat) ä½œä¸º Raft å®ç°ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

1. **Raft çŠ¶æ€æœº** (`ClusterStateMachine`)
   - ç®¡ç†é›†ç¾¤å…ƒæ•°æ®ï¼ˆbrokerä¿¡æ¯ã€topicé…ç½®ã€åˆ†åŒºåˆ†é…ï¼‰
   - ä¿è¯å…ƒæ•°æ®çš„å¼ºä¸€è‡´æ€§
   - å¤„ç†é›†ç¾¤æ“ä½œï¼ˆåˆ›å»ºtopicã€æ¶ˆæ¯å†™å…¥ç­‰ï¼‰

2. **é›†ç¾¤ç®¡ç†å™¨** (`cluster.Manager`)
   - åˆå§‹åŒ–å’Œç®¡ç† Raft èŠ‚ç‚¹
   - ç›‘æ§é¢†å¯¼è€…å˜åŒ–
   - å¤„ç†é›†ç¾¤æ“ä½œçš„è·¯ç”±

3. **Broker èŠ‚ç‚¹**
   - æ¯ä¸ª broker æ˜¯ä¸€ä¸ª Raft èŠ‚ç‚¹
   - å­˜å‚¨æœ¬åœ°æ•°æ®å’Œå‚ä¸ Raft åè®®
   - æä¾›å®¢æˆ·ç«¯æœåŠ¡æ¥å£

### æ•°æ®ä¸€è‡´æ€§

- **å…ƒæ•°æ®**: ä½¿ç”¨ Raft ä¿è¯å¼ºä¸€è‡´æ€§
- **æ¶ˆæ¯æ•°æ®**: å½“å‰ç‰ˆæœ¬ä»ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œåç»­ç‰ˆæœ¬å°†æ”¯æŒå‰¯æœ¬åŒæ­¥

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®æ–‡ä»¶

ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ `configs/broker-cluster-node1.json`:

```json
{
  "data_dir": "./data-node1",
  "max_topic_partitions": 16,
  "segment_size": 1073741824,
  "retention_time": "168h",
  // ... å…¶ä»–é…ç½® ...
  
  "server": {
    "port": "9092",
    "log_file": "logs/node1.log"
  },
  
  "cluster": {
    "enabled": true,
    "node_id": 1,
    "raft_address": "localhost:8001",
    "initial_members": [
      "localhost:8001",
      "localhost:8002", 
      "localhost:8003"
    ],
    "data_dir": "./raft-data/node1",
    "election_rtt": 10,
    "heartbeat_rtt": 1,
    "check_quorum": true,
    "snapshot_entries": 10000,
    "compaction_overhead": 5000
  }
}
```

### 2. å¯åŠ¨é›†ç¾¤

```bash
# æ–¹å¼1: ä½¿ç”¨æä¾›çš„è„šæœ¬
./scripts/start-cluster.sh

# æ–¹å¼2: æ‰‹åŠ¨å¯åŠ¨å„èŠ‚ç‚¹
./broker -config=configs/broker-cluster-node1.json &
./broker -config=configs/broker-cluster-node2.json &
./broker -config=configs/broker-cluster-node3.json &
```

### 3. æµ‹è¯•é›†ç¾¤

```bash
# è¿è¡Œé›†ç¾¤æµ‹è¯•
./scripts/test-cluster.sh
```

## ğŸ“‹ é…ç½®è¯´æ˜

### é›†ç¾¤é…ç½®å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `enabled` | æ˜¯å¦å¯ç”¨é›†ç¾¤æ¨¡å¼ | false |
| `node_id` | èŠ‚ç‚¹IDï¼ˆå¿…é¡»å”¯ä¸€ï¼‰ | - |
| `raft_address` | Rafté€šä¿¡åœ°å€ | - |
| `initial_members` | åˆå§‹æˆå‘˜åˆ—è¡¨ | - |
| `data_dir` | Raftæ•°æ®ç›®å½• | - |
| `election_rtt` | é€‰ä¸¾è¶…æ—¶RTT | 10 |
| `heartbeat_rtt` | å¿ƒè·³RTT | 1 |
| `check_quorum` | æ˜¯å¦æ£€æŸ¥æ³•å®šäººæ•° | true |
| `snapshot_entries` | å¿«ç…§æ¡ç›®æ•° | 10000 |
| `compaction_overhead` | å‹ç¼©å¼€é”€ | 5000 |

### ç«¯å£è§„åˆ’

- **ä¸šåŠ¡ç«¯å£**: 9092, 9093, 9094 (å®¢æˆ·ç«¯è¿æ¥)
- **Raftç«¯å£**: 8001, 8002, 8003 (èŠ‚ç‚¹é—´é€šä¿¡)

## ğŸ”§ è¿ç»´æ“ä½œ

### æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

```bash
# æ£€æŸ¥èŠ‚ç‚¹æ—¥å¿—
tail -f logs/node1.log

# æŸ¥çœ‹Raftæ•°æ®ç›®å½•
ls -la raft-data/node1/
```

### æ·»åŠ èŠ‚ç‚¹

1. åˆ›å»ºæ–°èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶
2. å¯åŠ¨æ–°èŠ‚ç‚¹
3. é€šè¿‡é›†ç¾¤APIæ·»åŠ æˆå‘˜ï¼ˆåŠŸèƒ½å¼€å‘ä¸­ï¼‰

### æ•…éšœæ¢å¤

- **å•èŠ‚ç‚¹æ•…éšœ**: è‡ªåŠ¨é€‰ä¸¾æ–°Leaderï¼ŒæœåŠ¡ç»§ç»­
- **å¤šèŠ‚ç‚¹æ•…éšœ**: éœ€è¦æ³•å®šäººæ•°èŠ‚ç‚¹æ‰èƒ½æ¢å¤æœåŠ¡
- **æ•°æ®æ¢å¤**: ä»Raftæ—¥å¿—å’Œå¿«ç…§è‡ªåŠ¨æ¢å¤

## ğŸ“Š ç›‘æ§å’Œè¯Šæ–­

### æ—¥å¿—ç›‘æ§

```bash
# ç›‘æ§Leaderé€‰ä¸¾
grep "became leader\|lost leadership" logs/*.log

# ç›‘æ§RaftçŠ¶æ€
grep "Raft cluster started" logs/*.log
```

### æ€§èƒ½æŒ‡æ ‡

- Raft æ—¥å¿—æ¡ç›®æ•°
- å¿«ç…§é¢‘ç‡
- é€‰ä¸¾æ¬¡æ•°
- ç½‘ç»œå»¶è¿Ÿ

## ğŸš§ å½“å‰é™åˆ¶

1. **æ•°æ®å‰¯æœ¬**: æ¶ˆæ¯æ•°æ®æš‚æœªå®ç°è·¨èŠ‚ç‚¹å‰¯æœ¬
2. **åŠ¨æ€æˆå‘˜**: ä¸æ”¯æŒåŠ¨æ€æ·»åŠ /åˆ é™¤èŠ‚ç‚¹
3. **è´Ÿè½½å‡è¡¡**: å®¢æˆ·ç«¯éœ€è¦æ‰‹åŠ¨é€‰æ‹©è¿æ¥çš„èŠ‚ç‚¹
4. **ç›‘æ§ç•Œé¢**: ç¼ºå°‘Webç®¡ç†ç•Œé¢

## ğŸ›£ï¸ åç»­è§„åˆ’

### çŸ­æœŸç›®æ ‡
- [ ] æ¶ˆæ¯æ•°æ®å‰¯æœ¬åŒæ­¥
- [ ] åŠ¨æ€æˆå‘˜ç®¡ç†
- [ ] å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
- [ ] æ•…éšœè‡ªåŠ¨åˆ‡æ¢

### é•¿æœŸç›®æ ‡
- [ ] è·¨æ•°æ®ä¸­å¿ƒéƒ¨ç½²
- [ ] æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿
- [ ] è‡ªåŠ¨æ‰©ç¼©å®¹
- [ ] å¤šç§Ÿæˆ·æ”¯æŒ

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPRæ¥æ”¹è¿›é›†ç¾¤åŠŸèƒ½ï¼

## ï¿½ï¿½ è®¸å¯è¯

MIT License 