# Go-Queue é¡¹ç›®æ–‡æ¡£

> æœ¬æ–‡æ¡£ä¸º Go-Queue åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿçš„å®Œæ•´è¯´æ˜ï¼Œé€‚åˆæ–°æ¥è§¦ä»£ç åº“çš„å¼€å‘è€…å¿«é€Ÿäº†è§£é¡¹ç›®æ¶æ„å’ŒåŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ¶æ„è¯´æ˜](#æ¶æ„è¯´æ˜)
3. [åŠŸèƒ½åˆ—è¡¨](#åŠŸèƒ½åˆ—è¡¨)
4. [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)
5. [å›å½’æµ‹è¯•æŠ¥å‘Š](#å›å½’æµ‹è¯•æŠ¥å‘Š)
6. [å¾…å®ŒæˆåŠŸèƒ½æ¸…å•](#å¾…å®ŒæˆåŠŸèƒ½æ¸…å•)
7. [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

**Go-Queue** æ˜¯ä¸€ä¸ªåŸºäº **Multi-Raft å…±è¯†ç®—æ³•** çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡ã€‚ç³»ç»Ÿé€šè¿‡ Dragonboat Raft å®ç°å¼ºä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§ï¼Œæ”¯æŒå¤šåˆ†åŒºã€å¤šå‰¯æœ¬çš„æ¶ˆæ¯å­˜å‚¨å’Œå¤„ç†ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **Multi-Raft æ¶æ„**: æ¯ä¸ªåˆ†åŒºç‹¬ç«‹çš„ Raft ç»„ï¼Œæä¾›çº¿æ€§æ‰©å±•èƒ½åŠ›
- âœ… **Controller Leader æ¨¡å¼**: é›†ä¸­å¼å…ƒæ•°æ®ç®¡ç†å’Œåˆ†åŒºåˆ†é…
- âœ… **å¼ºä¸€è‡´æ€§**: åŸºäº Raft å…±è¯†ç®—æ³•çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯
- âœ… **é«˜å¯ç”¨æ€§**: è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œ Leader é€‰ä¸¾
- âœ… **FollowerRead**: æ”¯æŒä» Follower èŠ‚ç‚¹è¯»å–ï¼Œæå‡è¯»æ€§èƒ½
- âœ… **è´Ÿè½½å‡è¡¡**: æ™ºèƒ½åˆ†åŒºåˆ†é…å’Œ Leader è½¬ç§»
- âœ… **æ¶ˆæ¯å‹ç¼©**: æ”¯æŒå¤šç§å‹ç¼©ç®—æ³•é™ä½å­˜å‚¨æˆæœ¬
- âœ… **æ¶ˆæ¯å»é‡**: åŸºäºå†…å®¹å“ˆå¸Œçš„é‡å¤æ¶ˆæ¯æ£€æµ‹

---

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Go-Queue é›†ç¾¤                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Broker Node 1 â”‚   Broker Node 2 â”‚   Broker Node 3         â”‚
â”‚                 â”‚                 â”‚                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ Controller  â”‚ â”‚ â”‚ Controller  â”‚ â”‚ â”‚ Controller  â”‚         â”‚
â”‚ â”‚ Follower    â”‚ â”‚ â”‚ Leader â­   â”‚ â”‚ â”‚ Follower    â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                 â”‚                 â”‚                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚Partition A-0â”‚ â”‚ â”‚Partition A-1â”‚ â”‚ â”‚Partition A-2â”‚         â”‚
â”‚ â”‚   Leader    â”‚ â”‚ â”‚  Follower   â”‚ â”‚ â”‚  Follower   â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                 â”‚                 â”‚                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚Partition B-0â”‚ â”‚ â”‚Partition B-1â”‚ â”‚ â”‚Partition B-2â”‚         â”‚
â”‚ â”‚  Follower   â”‚ â”‚ â”‚   Leader    â”‚ â”‚ â”‚  Follower   â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. **Broker (ä»£ç†èŠ‚ç‚¹)**
- **ä½ç½®**: `internal/broker/broker.go`
- **èŒè´£**: 
  - å¯åŠ¨å’Œç®¡ç†æ‰€æœ‰æœåŠ¡ç»„ä»¶
  - å¤„ç†å®¢æˆ·ç«¯è¿æ¥å’Œè¯·æ±‚
  - åè°ƒ Raft ç»„çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### 2. **Controller Manager (æ§åˆ¶å™¨ç®¡ç†å™¨)**
- **ä½ç½®**: `internal/broker/controller.go`
- **èŒè´£**:
  - **Leader èŒè´£**: åˆ†åŒºåˆ†é…ã€Raft ç»„å¯åœã€è´Ÿè½½å‡è¡¡
  - **æ‰€æœ‰èŠ‚ç‚¹**: å…ƒæ•°æ®æŸ¥è¯¢ã€çŠ¶æ€ç›‘æ§
  - **Leader Tasks**: å¥åº·æ£€æŸ¥ã€æ•…éšœæ£€æµ‹ã€è´Ÿè½½ç›‘æ§

#### 3. **Raft Manager (Raft ç®¡ç†å™¨)**
- **ä½ç½®**: `internal/raft/raft_manager.go`
- **èŒè´£**:
  - ç®¡ç†å¤šä¸ª Raft ç»„çš„ç”Ÿå‘½å‘¨æœŸ
  - æä¾› Raft æ“ä½œæ¥å£ (Propose, SyncRead, GetLeaderID)
  - ç›‘æ§ Leader å˜åŒ–å’Œç»„çŠ¶æ€

#### 4. **Controller StateMachine (æ§åˆ¶å™¨çŠ¶æ€æœº)**
- **ä½ç½®**: `internal/raft/controller_sm.go`
- **èŒè´£**:
  - åº”ç”¨é›†ç¾¤å…ƒæ•°æ®å˜æ›´ (Topic åˆ›å»º/åˆ é™¤, Broker æ³¨å†Œ)
  - ç»´æŠ¤åˆ†åŒºåˆ†é…ä¿¡æ¯
  - å¤„ç†æ¶ˆè´¹è€…ç»„çŠ¶æ€å˜æ›´

#### 5. **Partition StateMachine (åˆ†åŒºçŠ¶æ€æœº)**
- **ä½ç½®**: `internal/raft/partition_state_machine.go`
- **èŒè´£**:
  - å¤„ç†æ¶ˆæ¯ç”Ÿäº§å’Œæ¶ˆè´¹
  - ç®¡ç†åˆ†åŒºçº§åˆ«çš„ offset å’Œå­˜å‚¨
  - æ”¯æŒå¿«ç…§å’Œæ¢å¤

#### 6. **Partition Assigner (åˆ†åŒºåˆ†é…å™¨)**
- **ä½ç½®**: `internal/raft/multi_raft_partition_assigner.go`
- **èŒè´£**:
  - æ™ºèƒ½åˆ†åŒºåˆ†é…ç®—æ³•
  - è·¨ Broker çš„ Raft ç»„åè°ƒå¯åŠ¨
  - è´Ÿè½½å‡è¡¡å’Œ Leader è½¬ç§»

#### 7. **Client Server (å®¢æˆ·ç«¯æœåŠ¡å™¨)**
- **ä½ç½®**: `internal/broker/client_server.go`
- **èŒè´£**:
  - å¤„ç†å®¢æˆ·ç«¯åè®®è¯·æ±‚
  - è·¯ç”±è¯·æ±‚åˆ°æ­£ç¡®çš„ Raft ç»„
  - å®ç° FollowerRead ä¼˜åŒ–

### æ•°æ®æµ

#### æ¶ˆæ¯ç”Ÿäº§æµç¨‹
```
Client â†’ ClientServer â†’ findPartitionLeader â†’ PartitionStateMachine â†’ Storage
   â†“
Raft Propose â†’ Replicate to Followers â†’ Apply to StateMachine â†’ Return Offset
```

#### æ¶ˆæ¯æ¶ˆè´¹æµç¨‹
```
Client â†’ ClientServer â†’ findPartitionLeader â†’ PartitionStateMachine â†’ Storage
   â†“
(FollowerRead) SyncRead â†’ ReadIndex â†’ Apply â†’ Return Messages
```

#### Topic ç®¡ç†æµç¨‹
```
Client â†’ ControllerManager.CreateTopic â†’ PartitionAssigner â†’ Raft Propose
   â†“
ControllerStateMachine.Apply â†’ Update Metadata â†’ Return Success
```

---

## âœ… åŠŸèƒ½åˆ—è¡¨

### å·²å®ç°æ ¸å¿ƒåŠŸèƒ½

#### **æ¶ˆæ¯ç³»ç»Ÿ**
- [x] **æ¶ˆæ¯ç”Ÿäº§**: æ”¯æŒæ‰¹é‡æ¶ˆæ¯ç”Ÿäº§åˆ°æŒ‡å®šåˆ†åŒº
- [x] **æ¶ˆæ¯æ¶ˆè´¹**: æ”¯æŒæŒ‡å®š offset çš„æ¶ˆæ¯æ¶ˆè´¹
- [x] **æ¶ˆæ¯å­˜å‚¨**: åŸºäº Segment çš„æŒä¹…åŒ–å­˜å‚¨
- [x] **æ¶ˆæ¯å‹ç¼©**: æ”¯æŒ Gzip, Snappy, LZ4 å‹ç¼©ç®—æ³•
- [x] **æ¶ˆæ¯å»é‡**: åŸºäºå†…å®¹å“ˆå¸Œçš„é‡å¤æ¶ˆæ¯æ£€æµ‹

#### **Topic ç®¡ç†**
- [x] **Topic åˆ›å»º**: æ”¯æŒæŒ‡å®šåˆ†åŒºæ•°å’Œå‰¯æœ¬æ•°
- [x] **Topic åˆ é™¤**: å®Œæ•´çš„å…ƒæ•°æ®å’Œå­˜å‚¨æ¸…ç†
- [x] **Topic åˆ—è¡¨**: è·å–æ‰€æœ‰ Topic ä¿¡æ¯
- [x] **Topic è¯¦æƒ…**: è·å–å•ä¸ª Topic çš„è¯¦ç»†ä¿¡æ¯

#### **åˆ†åŒºç®¡ç†**
- [x] **æ™ºèƒ½åˆ†åŒºåˆ†é…**: åŸºäº Broker è´Ÿè½½çš„åˆ†åŒºåˆ†é…ç®—æ³•
- [x] **å¤šå‰¯æœ¬æ”¯æŒ**: å¯é…ç½®çš„å‰¯æœ¬å› å­
- [x] **Leader é€‰ä¸¾**: è‡ªåŠ¨ Leader æ•…éšœè½¬ç§»
- [x] **è´Ÿè½½å‡è¡¡**: è‡ªåŠ¨ Leader è½¬ç§»å’Œé‡æ–°å¹³è¡¡

#### **é›†ç¾¤ç®¡ç†**
- [x] **Broker æ³¨å†Œ**: åŠ¨æ€ Broker èŠ‚ç‚¹æ³¨å†Œå’Œå‘ç°
- [x] **Controller Leader**: é›†ä¸­å¼é›†ç¾¤å…ƒæ•°æ®ç®¡ç†
- [x] **å¥åº·æ£€æŸ¥**: å®šæœŸèŠ‚ç‚¹å¥åº·æ£€æµ‹
- [x] **æ•…éšœæ£€æµ‹**: è‡ªåŠ¨æ•…éšœ Broker æ£€æµ‹å’Œå¤„ç†

#### **æ€§èƒ½ä¼˜åŒ–**
- [x] **FollowerRead**: ä» Follower èŠ‚ç‚¹è¯»å–å‡å°‘ Leader è´Ÿè½½
- [x] **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ¶ˆæ¯å¤„ç†
- [x] **è¿æ¥å¤ç”¨**: é«˜æ•ˆçš„ç½‘ç»œè¿æ¥ç®¡ç†
- [x] **å…ƒæ•°æ®ç¼“å­˜**: æœ¬åœ°å…ƒæ•°æ®ç¼“å­˜å‡å°‘ç½‘ç»œè°ƒç”¨

#### **æ¶ˆè´¹è€…ç»„ (åŸºç¡€æ”¯æŒ)**
- [x] **ç»„ç®¡ç†**: æ¶ˆè´¹è€…ç»„çš„åˆ›å»ºå’Œç®¡ç†
- [x] **æˆå‘˜ç®¡ç†**: æ¶ˆè´¹è€…åŠ å…¥å’Œç¦»å¼€ç»„
- [x] **Offset ç®¡ç†**: æ¶ˆè´¹è¿›åº¦çš„æŒä¹…åŒ–å­˜å‚¨

### å®¢æˆ·ç«¯åŠŸèƒ½

#### **Producer (ç”Ÿäº§è€…)**
- [x] **åŒæ­¥ç”Ÿäº§**: ç­‰å¾…ç¡®è®¤çš„æ¶ˆæ¯å‘é€
- [x] **æ‰¹é‡ç”Ÿäº§**: å¤šæ¶ˆæ¯æ‰¹é‡å‘é€
- [x] **åˆ†åŒºè·¯ç”±**: è‡ªåŠ¨åˆ†åŒº Leader å‘ç°
- [x] **é‡è¯•æœºåˆ¶**: è‡ªåŠ¨é‡è¯•å’Œé”™è¯¯å¤„ç†

#### **Consumer (æ¶ˆè´¹è€…)**
- [x] **æ¶ˆæ¯æ‹‰å–**: åŸºäº offset çš„æ¶ˆæ¯æ‹‰å–
- [x] **æ‰¹é‡æ¶ˆè´¹**: æ‰¹é‡æ¶ˆæ¯è·å–
- [x] **è‡ªåŠ¨é‡è¿**: è¿æ¥æ•…éšœè‡ªåŠ¨æ¢å¤

#### **Admin (ç®¡ç†)**
- [x] **Topic ç®¡ç†**: åˆ›å»ºã€åˆ é™¤ã€åˆ—è¡¨ Topic
- [x] **é›†ç¾¤ä¿¡æ¯**: è·å–é›†ç¾¤çŠ¶æ€å’Œå…ƒæ•°æ®
- [x] **Controller å‘ç°**: è‡ªåŠ¨ Controller Leader å‘ç°

---

## ğŸ“š ä½¿ç”¨è¯´æ˜

### ç¯å¢ƒè¦æ±‚

- **Go**: 1.21+ (æ”¯æŒ slog å’Œæœ€æ–°ç‰¹æ€§)
- **æ“ä½œç³»ç»Ÿ**: Linux, macOS, Windows
- **ç½‘ç»œ**: é›†ç¾¤èŠ‚ç‚¹é—´ç½‘ç»œäº’é€š
- **å­˜å‚¨**: æŒä¹…åŒ–å­˜å‚¨ç©ºé—´

### å¿«é€Ÿå¼€å§‹

#### 1. å¯åŠ¨å•ä¸ª Broker

```bash
# ç¼–è¯‘é¡¹ç›®
go build -o go-queue ./cmd/broker/main.go

# å¯åŠ¨ Broker
./go-queue -config=broker-config.json
```

#### 2. é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json
{
  "data_dir": "./data",
  "max_topic_partitions": 1000,
  "segment_size": 104857600,
  "retention_time": "168h",
  "max_storage_size": 1073741824000,
  "flush_interval": "5s",
  "cleanup_interval": "1h",
  "max_message_size": 1048576,
  "compression_enabled": true,
  "compression_type": "gzip",
  "compression_threshold": 1024,
  "deduplication_enabled": false,
  "server": {
    "port": "9092",
    "log_file": "./logs/broker.log"
  },
  "enable_follower_read": true
}
```

#### 3. å¯åŠ¨å¤šèŠ‚ç‚¹é›†ç¾¤

```bash
# èŠ‚ç‚¹ 1 (Controller Leader)
./go-queue -config=broker1.json -broker-id=broker1 -raft-addr=localhost:7001 -client-addr=localhost:9092

# èŠ‚ç‚¹ 2
./go-queue -config=broker2.json -broker-id=broker2 -raft-addr=localhost:7002 -client-addr=localhost:9093

# èŠ‚ç‚¹ 3
./go-queue -config=broker3.json -broker-id=broker3 -raft-addr=localhost:7003 -client-addr=localhost:9094
```

### å®¢æˆ·ç«¯ä½¿ç”¨

#### Producer ç¤ºä¾‹

```go
package main

import (
    "log"
    "time"
    "github.com/issac1998/go-queue/client"
)

func main() {
    // åˆ›å»ºå®¢æˆ·ç«¯
    c := client.NewClient(client.ClientConfig{
        BrokerAddrs: []string{"localhost:9092", "localhost:9093", "localhost:9094"},
        Timeout:     5 * time.Second,
    })

    // åˆ›å»ºç”Ÿäº§è€…
    producer := client.NewProducer(c)

    // å‘é€æ¶ˆæ¯
    result, err := producer.ProduceMessage(client.ProduceRequest{
        Topic:     "my-topic",
        Partition: 0,
        Messages: []client.Message{
            {Key: "key1", Value: []byte("Hello, World!")},
        },
    })
    
    if err != nil {
        log.Fatalf("Failed to produce message: %v", err)
    }
    
    log.Printf("Message produced at offset: %d", result.Offset)
}
```

#### Consumer ç¤ºä¾‹

```go
package main

import (
    "log"
    "time"
    "github.com/issac1998/go-queue/client"
)

func main() {
    // åˆ›å»ºå®¢æˆ·ç«¯
    c := client.NewClient(client.ClientConfig{
        BrokerAddrs: []string{"localhost:9092", "localhost:9093", "localhost:9094"},
        Timeout:     5 * time.Second,
    })

    // åˆ›å»ºæ¶ˆè´¹è€…
    consumer := client.NewConsumer(c)

    // æ¶ˆè´¹æ¶ˆæ¯
    result, err := consumer.FetchFrom(client.FetchRequest{
        Topic:     "my-topic",
        Partition: 0,
        Offset:    0,
        MaxBytes:  1024 * 1024, // 1MB
    })
    
    if err != nil {
        log.Fatalf("Failed to fetch messages: %v", err)
    }
    
    for _, msg := range result.Messages {
        log.Printf("Received message: key=%s, value=%s, offset=%d", 
            msg.Key, string(msg.Value), msg.Offset)
    }
}
```

#### Admin ç¤ºä¾‹

```go
package main

import (
    "log"
    "time"
    "github.com/issac1998/go-queue/client"
)

func main() {
    // åˆ›å»ºå®¢æˆ·ç«¯
    c := client.NewClient(client.ClientConfig{
        BrokerAddrs: []string{"localhost:9092", "localhost:9093", "localhost:9094"},
        Timeout:     5 * time.Second,
    })

    // åˆ›å»ºç®¡ç†å‘˜
    admin := client.NewAdmin(c)

    // åˆ›å»º Topic
    result, err := admin.CreateTopic(client.CreateTopicRequest{
        Name:       "my-topic",
        Partitions: 3,
        Replicas:   3,
    })
    
    if err != nil {
        log.Fatalf("Failed to create topic: %v", err)
    }
    
    log.Printf("Topic created: %s", result.Name)

    // åˆ—å‡ºæ‰€æœ‰ Topic
    topics, err := admin.ListTopics()
    if err != nil {
        log.Fatalf("Failed to list topics: %v", err)
    }
    
    for _, topic := range topics.Topics {
        log.Printf("Topic: %s, Partitions: %d", topic.Name, topic.Partitions)
    }
}
```

---

## ğŸ§ª å›å½’æµ‹è¯•æŠ¥å‘Š

### æµ‹è¯•æ‰§è¡Œæƒ…å†µ

**æ‰§è¡Œæ—¶é—´**: 2024å¹´12æœˆ
**æµ‹è¯•å‘½ä»¤**: `go test -v ./...`
**æ€»ä½“ç»“æœ**: éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸

### æµ‹è¯•ç»“æœåˆ†æ

#### âœ… **é€šè¿‡çš„æµ‹è¯•ç»„ä»¶**

| ç»„ä»¶ | æµ‹è¯•æ•°é‡ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| **Storage** | 7/7 | âœ… PASS | å­˜å‚¨å±‚åŠŸèƒ½å®Œå…¨æ­£å¸¸ |
| **Broker Core** | 6/8 | âœ… å¤§éƒ¨åˆ†é€šè¿‡ | æ ¸å¿ƒ Broker åŠŸèƒ½æ­£å¸¸ |
| **Integration** | 1/1 | âœ… SKIP | é›†æˆæµ‹è¯•è·³è¿‡ï¼ˆéœ€è¦ç¯å¢ƒå˜é‡ï¼‰ |
| **Metadata** | 4/4 | âœ… PASS | å…ƒæ•°æ®ç®¡ç†åŠŸèƒ½æ­£å¸¸ |

#### âš ï¸ **å¤±è´¥çš„æµ‹è¯•ç»„ä»¶**

| ç»„ä»¶ | é—®é¢˜ | å½±å“ç¨‹åº¦ | ä¿®å¤ä¼˜å…ˆçº§ |
|------|------|---------|----------|
| **Protocol Constants** | å¸¸é‡å€¼ä¸åŒ¹é… | ä½ | ä¸­ |
| **Client Tests** | ç½‘ç»œè¿æ¥å¤±è´¥ | ä½ | ä½ |
| **Request Type Mapping** | é…ç½®æ˜ å°„é”™è¯¯ | ä½ | ä¸­ |

#### ğŸ“‹ **å…·ä½“å¤±è´¥åˆ†æ**

1. **Protocol Constants ä¸åŒ¹é…**
   - **é—®é¢˜**: è¯·æ±‚ç±»å‹å¸¸é‡å€¼ä¸æµ‹è¯•æœŸæœ›ä¸ç¬¦
   - **åŸå› **: é‡æ„åå¸¸é‡é‡æ–°ç¼–å·
   - **å½±å“**: ä¸å½±å“å®é™…åŠŸèƒ½ï¼Œä»…å½±å“æµ‹è¯•
   - **ä¿®å¤**: æ›´æ–°æµ‹è¯•æœŸæœ›å€¼

2. **Client è¿æ¥æµ‹è¯•å¤±è´¥**
   - **é—®é¢˜**: æ— æ³•è¿æ¥åˆ° Broker (è¿æ¥è¢«æ‹’ç»)
   - **åŸå› **: æµ‹è¯•ç¯å¢ƒæ²¡æœ‰è¿è¡Œ Broker å®ä¾‹
   - **å½±å“**: æµ‹è¯•è¦†ç›–ç‡é™ä½ï¼Œä¸å½±å“å®é™…åŠŸèƒ½
   - **ä¿®å¤**: ä½¿ç”¨ Mock æˆ–å¯åŠ¨æµ‹è¯• Broker

3. **Request Type é…ç½®ç¼ºå¤±**
   - **é—®é¢˜**: Controller Discovery ç­‰è¯·æ±‚ç±»å‹é…ç½®ç¼ºå¤±
   - **åŸå› **: æ¸…ç†è¿‡ç¨‹ä¸­ç§»é™¤äº†éƒ¨åˆ†é…ç½®
   - **å½±å“**: ç‰¹å®šè¯·æ±‚ç±»å‹å¤„ç†å¼‚å¸¸
   - **ä¿®å¤**: è¡¥å……ç¼ºå¤±çš„é…ç½®æ˜ å°„

### æ ¸å¿ƒåŠŸèƒ½éªŒè¯

#### âœ… **ç¼–è¯‘éªŒè¯**
```bash
go build -o /tmp/go-queue ./cmd/broker/main.go
# ç»“æœ: ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```

#### âœ… **å­˜å‚¨åŠŸèƒ½éªŒè¯**
- Segment è¯»å†™æ­£å¸¸
- æ•°æ®æŒä¹…åŒ–æ­£å¸¸
- ç´¢å¼•æŸ¥æ‰¾æ­£å¸¸

#### âœ… **å…ƒæ•°æ®ç®¡ç†éªŒè¯**
- Topic åˆ›å»ºåˆ é™¤æ­£å¸¸
- åˆ†åŒºç®¡ç†æ­£å¸¸
- æ¶ˆè´¹è€…ç»„ç®¡ç†æ­£å¸¸

### æµ‹è¯•è¦†ç›–ç‡è¯„ä¼°

| åŠŸèƒ½æ¨¡å— | è¦†ç›–ç‡ä¼°è®¡ | è´¨é‡è¯„çº§ |
|----------|-----------|----------|
| **æ ¸å¿ƒå­˜å‚¨** | 90%+ | ğŸŸ¢ ä¼˜ç§€ |
| **Raft ç®¡ç†** | 70%+ | ğŸŸ¡ è‰¯å¥½ |
| **å®¢æˆ·ç«¯åè®®** | 60%+ | ğŸŸ¡ è‰¯å¥½ |
| **é›†ç¾¤ç®¡ç†** | 50%+ | ğŸŸ  å¾…æå‡ |

---

## ğŸ“ å¾…å®ŒæˆåŠŸèƒ½æ¸…å•

### ğŸš¨ é«˜ä¼˜å…ˆçº§ (æ ¸å¿ƒåŠŸèƒ½)

#### **ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ**
- [ ] **å®ç° slog é›†æˆ** - æ›¿æ¢ç°æœ‰çš„ log.Printf
- [ ] **æ—¥å¿—çº§åˆ«é…ç½®** - Debug, Info, Warn, Error
- [ ] **ç»“æ„åŒ–å­—æ®µ** - æ”¯æŒ key-value æ—¥å¿—æ ¼å¼
- [ ] **æ—¥å¿—è½®è½¬** - åŸºäºå¤§å°å’Œæ—¶é—´çš„æ—¥å¿—è½®è½¬
- [ ] **åˆ†å¸ƒå¼è¿½è¸ª** - è¯·æ±‚é“¾è·¯è¿½è¸ªæ”¯æŒ

#### **æµ‹è¯•å®Œå–„**
- [ ] **ä¿®å¤ Protocol Constants** - æ›´æ–°æµ‹è¯•æœŸæœ›å€¼
- [ ] **è¡¥å……å•å…ƒæµ‹è¯•** - æå‡æµ‹è¯•è¦†ç›–ç‡åˆ° 80%+
- [ ] **é›†æˆæµ‹è¯•ç¯å¢ƒ** - è‡ªåŠ¨åŒ–é›†æˆæµ‹è¯•ç¯å¢ƒ
- [ ] **æ€§èƒ½æµ‹è¯•** - ååé‡å’Œå»¶è¿ŸåŸºå‡†æµ‹è¯•
- [ ] **æ•…éšœæ³¨å…¥æµ‹è¯•** - ç½‘ç»œåˆ†åŒºã€èŠ‚ç‚¹æ•…éšœæµ‹è¯•

#### **é…ç½®ç®¡ç†**
- [ ] **é…ç½®çƒ­é‡è½½** - è¿è¡Œæ—¶é…ç½®æ›´æ–°
- [ ] **ç¯å¢ƒå˜é‡æ”¯æŒ** - æ”¯æŒç¯å¢ƒå˜é‡é…ç½®
- [ ] **é…ç½®éªŒè¯** - å¯åŠ¨æ—¶é…ç½®æœ‰æ•ˆæ€§æ£€æŸ¥
- [ ] **é»˜è®¤é…ç½®** - åˆç†çš„é»˜è®¤é…ç½®å€¼

### ğŸ”§ ä¸­ä¼˜å…ˆçº§ (åŠŸèƒ½å¢å¼º)

#### **æ¶ˆè´¹è€…ç»„å¢å¼º**
- [ ] **è‡ªåŠ¨åˆ†åŒºåˆ†é…** - æ¶ˆè´¹è€…ç»„å†…è‡ªåŠ¨åˆ†åŒºåˆ†é…
- [ ] **é‡æ–°å¹³è¡¡** - æ¶ˆè´¹è€…åŠ å…¥/ç¦»å¼€æ—¶çš„é‡æ–°å¹³è¡¡
- [ ] **å¿ƒè·³æœºåˆ¶** - å®šæœŸå¿ƒè·³æ£€æµ‹æ¶ˆè´¹è€…æ´»è·ƒæ€§
- [ ] **ä¼šè¯ç®¡ç†** - æ¶ˆè´¹è€…ä¼šè¯è¶…æ—¶å’Œæ¢å¤

#### **æ€§èƒ½ä¼˜åŒ–**
- [ ] **æ‰¹é‡æäº¤ä¼˜åŒ–** - Raft æ‰¹é‡æ“ä½œä¼˜åŒ–
- [ ] **å†…å­˜æ± ** - å¯¹è±¡å¤ç”¨å‡å°‘ GC å‹åŠ›
- [ ] **ç½‘ç»œä¼˜åŒ–** - è¿æ¥æ± å’Œå¤šè·¯å¤ç”¨
- [ ] **å­˜å‚¨ä¼˜åŒ–** - å‹ç¼©å’Œæ¸…ç†ç­–ç•¥ä¼˜åŒ–

#### **è¿ç»´åŠŸèƒ½**
- [ ] **æŒ‡æ ‡æ”¶é›†** - Prometheus æŒ‡æ ‡å¯¼å‡º
- [ ] **å¥åº·æ£€æŸ¥ç«¯ç‚¹** - HTTP å¥åº·æ£€æŸ¥æ¥å£
- [ ] **ç®¡ç† API** - REST API ç®¡ç†æ¥å£
- [ ] **é›†ç¾¤æ‹“æ‰‘æŸ¥çœ‹** - é›†ç¾¤çŠ¶æ€å¯è§†åŒ–

#### **å®‰å…¨æ€§**
- [ ] **TLS æ”¯æŒ** - èŠ‚ç‚¹é—´å’Œå®¢æˆ·ç«¯é€šä¿¡åŠ å¯†
- [ ] **è®¤è¯æˆæƒ** - åŸºäºç”¨æˆ·çš„è®¿é—®æ§åˆ¶
- [ ] **å®¡è®¡æ—¥å¿—** - æ“ä½œå®¡è®¡å’Œæ—¥å¿—è®°å½•

### ğŸ“ˆ ä½ä¼˜å…ˆçº§ (å¯é€‰åŠŸèƒ½)

#### **é«˜çº§ç‰¹æ€§**
- [ ] **æ¶ˆæ¯äº‹åŠ¡** - è·¨åˆ†åŒºäº‹åŠ¡æ”¯æŒ
- [ ] **æµå¤„ç†** - åŸºç¡€æµå¤„ç†èƒ½åŠ›
- [ ] **æ¶ˆæ¯è·¯ç”±** - åŸºäºå†…å®¹çš„æ¶ˆæ¯è·¯ç”±
- [ ] **å»¶è¿Ÿæ¶ˆæ¯** - å®šæ—¶æ¶ˆæ¯å‘é€

#### **ç”Ÿæ€é›†æˆ**
- [ ] **Kafka åè®®å…¼å®¹** - éƒ¨åˆ† Kafka åè®®æ”¯æŒ
- [ ] **Prometheus é›†æˆ** - è¯¦ç»†æŒ‡æ ‡ç›‘æ§
- [ ] **Grafana é¢æ¿** - ç›‘æ§ä»ªè¡¨æ¿
- [ ] **Docker æ”¯æŒ** - å®¹å™¨åŒ–éƒ¨ç½²

#### **å·¥å…·é“¾**
- [ ] **CLI å·¥å…·** - å‘½ä»¤è¡Œç®¡ç†å·¥å…·
- [ ] **Web æ§åˆ¶å°** - Web ç®¡ç†ç•Œé¢
- [ ] **è¿ç§»å·¥å…·** - æ•°æ®è¿ç§»å·¥å…·
- [ ] **å¤‡ä»½æ¢å¤** - æ•°æ®å¤‡ä»½å’Œæ¢å¤å·¥å…·

### ğŸ› é—®é¢˜ä¿®å¤

#### **å·²çŸ¥é—®é¢˜**
- [ ] **Protocol å¸¸é‡åŒæ­¥** - ä¿®å¤å¸¸é‡å€¼ä¸åŒ¹é…
- [ ] **Request Type æ˜ å°„** - è¡¥å……ç¼ºå¤±çš„è¯·æ±‚ç±»å‹é…ç½®
- [ ] **æµ‹è¯•ç¯å¢ƒ** - ä¿®å¤å®¢æˆ·ç«¯æµ‹è¯•çš„ç½‘ç»œé—®é¢˜
- [ ] **å†…å­˜æ³„æ¼** - æ’æŸ¥å’Œä¿®å¤æ½œåœ¨çš„å†…å­˜æ³„æ¼

#### **æ€§èƒ½é—®é¢˜**
- [ ] **Raft å†™å…¥å»¶è¿Ÿ** - ä¼˜åŒ– Raft å†™å…¥æ€§èƒ½
- [ ] **ç½‘ç»œè¿æ¥æ•°** - ä¼˜åŒ–ç½‘ç»œè¿æ¥ç®¡ç†
- [ ] **åƒåœ¾å›æ”¶** - å‡å°‘ GC åœé¡¿æ—¶é—´

---

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### ä»£ç ç»“æ„

```
go-queue/
â”œâ”€â”€ cmd/                    # å‘½ä»¤è¡Œå·¥å…·
â”‚   â”œâ”€â”€ broker/            # Broker ä¸»ç¨‹åº
â”‚   â””â”€â”€ client/            # å®¢æˆ·ç«¯å·¥å…·
â”œâ”€â”€ client/                # å®¢æˆ·ç«¯ SDK
â”‚   â”œâ”€â”€ admin.go           # ç®¡ç†å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ consumer.go        # æ¶ˆè´¹è€…å®¢æˆ·ç«¯
â”‚   â””â”€â”€ producer.go        # ç”Ÿäº§è€…å®¢æˆ·ç«¯
â”œâ”€â”€ internal/              # å†…éƒ¨åŒ…
â”‚   â”œâ”€â”€ broker/            # Broker å®ç°
â”‚   â”œâ”€â”€ raft/              # Raft ç›¸å…³å®ç°
â”‚   â”œâ”€â”€ protocol/          # åè®®å®šä¹‰
â”‚   â”œâ”€â”€ storage/           # å­˜å‚¨å±‚
â”‚   â””â”€â”€ config/            # é…ç½®ç®¡ç†
â”œâ”€â”€ examples/              # ç¤ºä¾‹ä»£ç 
â””â”€â”€ docs/                  # æ–‡æ¡£
```

### å…³é”®è®¾è®¡åŸåˆ™

1. **Single Responsibility**: æ¯ä¸ªç»„ä»¶èŒè´£å•ä¸€æ˜ç¡®
2. **Controller Leader æ¨¡å¼**: é›†ä¸­å¼å…ƒæ•°æ®ç®¡ç†
3. **Multi-Raft**: åˆ†åŒºçº§åˆ«çš„ç‹¬ç«‹ Raft ç»„
4. **FollowerRead**: è¯»å†™åˆ†ç¦»æå‡æ€§èƒ½
5. **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„æ—¥å¿—å’ŒæŒ‡æ ‡

### è´¡çŒ®æŒ‡å—

1. **Fork é¡¹ç›®** å¹¶åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
2. **ç¼–å†™æµ‹è¯•** ç¡®ä¿æµ‹è¯•è¦†ç›–ç‡
3. **éµå¾ªä»£ç è§„èŒƒ** ä½¿ç”¨ gofmt å’Œ golint
4. **æ›´æ–°æ–‡æ¡£** åŒæ­¥æ›´æ–°ç›¸å…³æ–‡æ¡£
5. **æäº¤ PR** æè¿°å˜æ›´å†…å®¹å’ŒåŸå› 

### è°ƒè¯•æŠ€å·§

1. **æ—¥å¿—åˆ†æ**: æŸ¥çœ‹ Raft å’Œ Controller æ—¥å¿—
2. **çŠ¶æ€æ£€æŸ¥**: ä½¿ç”¨ç®¡ç† API æ£€æŸ¥é›†ç¾¤çŠ¶æ€
3. **ç½‘ç»œå·¥å…·**: ä½¿ç”¨ netstat æ£€æŸ¥ç½‘ç»œè¿æ¥
4. **æ€§èƒ½åˆ†æ**: ä½¿ç”¨ pprof è¿›è¡Œæ€§èƒ½åˆ†æ

---

## ğŸ“ è”ç³»æ–¹å¼

- **é¡¹ç›®åœ°å€**: https://github.com/issac1998/go-queue
- **é—®é¢˜åé¦ˆ**: é€šè¿‡ GitHub Issues
- **æ–‡æ¡£æ›´æ–°**: éšä»£ç å˜æ›´åŒæ­¥æ›´æ–°

---

**æœ€åæ›´æ–°**: 2024å¹´12æœˆ
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**é€‚ç”¨ä»£ç ç‰ˆæœ¬**: å½“å‰ main åˆ†æ”¯