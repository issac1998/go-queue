# Go-Queue 当前功能完整文档

## 概述

Go-Queue 是一个基于 Multi-Raft 架构的高性能分布式消息队列系统，提供强一致性、高可用性的消息传递服务。

## 核心架构

### 1. Multi-Raft 架构
- **Controller Raft Group**: 管理集群元数据（Topic、Partition、Consumer Group等）
- **Partition Raft Groups**: 每个分区独立的Raft组，负责消息存储和复制
- **Leader选举**: 自动故障检测和Leader切换
- **强一致性**: 基于Raft共识算法保证数据一致性

### 2. 存储引擎
- **Segment-based存储**: 消息按Segment分片存储
- **索引机制**: 支持Offset索引和时间索引
- **持久化**: 数据持久化到磁盘，支持故障恢复
- **压缩支持**: 支持Gzip、Snappy、LZ4等压缩算法

### 3. 网络协议
- **自定义二进制协议**: 高性能TCP通信
- **版本控制**: 协议版本管理
- **连接复用**: 高效的连接管理

## 已实现功能

### 1. 核心消息功能

#### 消息生产 (Producer)
- **单条消息发送**: 支持指定Topic和Partition
- **批量消息发送**: 支持批量提交提高吞吐量
- **同步发送**: 等待确认的消息发送
- **消息压缩**: 支持多种压缩算法
- **消息去重**: 基于内容哈希的重复消息检测
- **顺序消息**: 基于MessageGroup的顺序消息投递

#### 消息消费 (Consumer)
- **指定Offset消费**: 从指定位置开始消费
- **批量拉取**: 支持批量获取消息
- **订阅模式**: 持续订阅消息流
- **FollowerRead**: 支持从Follower节点读取减少Leader负载

#### 事务支持
- **生产者事务**: 支持事务性消息发送
- **消费者事务**: 支持事务性消息处理
- **两阶段提交**: 完整的事务提交流程
- **事务回滚**: 支持事务回滚机制

### 2. Topic管理

#### Topic操作
- **创建Topic**: 支持指定分区数和副本数
- **删除Topic**: 完整的Topic删除，包括元数据和存储清理
- **列出Topics**: 获取所有Topic信息
- **Topic详情**: 获取单个Topic的详细信息

#### 分区管理
- **智能分区分配**: 基于Broker负载的分区分配算法
- **多副本支持**: 可配置的副本因子
- **Leader选举**: 自动Leader故障转移
- **负载均衡**: 自动Leader转移和重新平衡

### 3. Consumer Group

#### 组管理
- **创建Consumer Group**: 动态创建消费者组
- **加入/离开组**: 消费者动态加入和离开
- **分区分配**: 自动分区分配和重平衡
- **心跳机制**: 定期心跳检测消费者状态

#### Offset管理
- **Offset提交**: 消费进度的持久化存储
- **Offset查询**: 查询消费者组的消费进度
- **自动提交**: 支持自动Offset提交

### 4. 集群管理

#### Broker管理
- **Broker注册**: 动态Broker节点注册和发现
- **服务发现**: 支持内存和etcd两种发现机制
- **健康检查**: 定期节点健康检测
- **故障检测**: 自动故障Broker检测和处理

#### Controller管理
- **Controller Leader**: 集中式集群元数据管理
- **元数据同步**: 集群元数据的一致性保证
- **自动发现**: 客户端自动发现Controller Leader

### 5. 高级功能

#### 死信队列 (DLQ)
- **失败消息处理**: 自动将失败消息发送到死信队列
- **重试机制**: 支持消息重试
- **DLQ查询**: 查询死信队列中的消息
- **消息重处理**: 支持从死信队列重新处理消息

#### 消息去重
- **内容哈希**: 基于消息内容的去重
- **幂等性保证**: 确保消息处理的幂等性
- **过期清理**: 自动清理过期的去重记录

#### 顺序消息
- **MessageGroup路由**: 基于MessageGroup的分区路由
- **严格有序**: 同一MessageGroup内消息严格有序
- **负载均衡**: 不同MessageGroup间的负载均衡

### 6. 性能优化

#### 批量操作
- **批量生产**: 支持批量消息发送
- **批量消费**: 支持批量消息拉取
- **批量提交**: 支持批量Offset提交

#### 连接优化
- **连接池**: 高效的连接池管理
- **异步IO**: 支持异步IO操作
- **连接复用**: 减少连接开销

#### 缓存机制
- **元数据缓存**: 本地元数据缓存减少网络调用
- **索引缓存**: 内存中的索引缓存加速查找

## 客户端SDK

### 支持的客户端类型
- **Producer**: 消息生产者
- **Consumer**: 消息消费者
- **Admin**: 管理客户端
- **GroupConsumer**: 消费者组消费者
- **TransactionProducer**: 事务生产者
- **TransactionalConsumer**: 事务消费者
- **OrderedProducer**: 顺序消息生产者

### 配置选项
- **多Broker地址**: 支持配置多个Broker地址
- **超时设置**: 可配置的连接和请求超时
- **自动重连**: 支持自动重连机制
- **故障转移**: 自动故障转移支持

## 协议支持

### 请求类型
- **PRODUCE**: 消息生产请求
- **FETCH**: 消息消费请求
- **CREATE_TOPIC**: 创建Topic请求
- **DELETE_TOPIC**: 删除Topic请求
- **LIST_TOPICS**: 列出Topics请求
- **JOIN_GROUP**: 加入消费者组请求
- **LEAVE_GROUP**: 离开消费者组请求
- **COMMIT_OFFSET**: 提交Offset请求
- **HEARTBEAT**: 心跳请求
- **TRANSACTION_***: 各种事务相关请求
- **ORDERED_PRODUCE**: 顺序消息生产请求

### 错误处理
- **详细错误码**: 完整的错误码体系
- **错误恢复**: 自动错误恢复机制
- **重试逻辑**: 智能重试策略

## 监控和运维

### 指标收集
- **性能指标**: 吞吐量、延迟等性能指标
- **健康指标**: 节点健康状态
- **资源使用**: CPU、内存、磁盘使用情况

### 日志系统
- **结构化日志**: 支持结构化日志输出
- **日志级别**: 支持多种日志级别
- **分布式追踪**: 请求链路追踪支持

## 配置管理

### 配置文件
- **YAML格式**: 人类友好的配置格式
- **命令行覆盖**: 支持命令行参数覆盖配置
- **环境变量**: 支持环境变量配置

### 配置项
- **Raft配置**: RTT、选举超时等Raft参数
- **存储配置**: Segment大小、保留策略等
- **网络配置**: 端口、地址、超时等
- **性能配置**: 批量大小、连接池大小等

## 部署模式

### 单机模式
- **开发测试**: 适合开发和测试环境
- **快速启动**: 简单的启动配置

### 集群模式
- **高可用**: 多节点集群部署
- **负载均衡**: 自动负载均衡
- **故障恢复**: 自动故障恢复

### 服务发现
- **内存模式**: 适合单机或小规模部署
- **etcd模式**: 适合生产环境的服务发现

## 示例和工具

### 命令行工具
- **创建Topic**: 命令行创建Topic
- **发送消息**: 命令行发送消息
- **消费消息**: 命令行消费消息
- **管理操作**: 各种管理操作

### 示例程序
- **基础示例**: 简单的生产消费示例
- **Consumer Group示例**: 消费者组使用示例
- **事务示例**: 事务使用示例
- **顺序消息示例**: 顺序消息使用示例
- **高性能示例**: 高性能使用示例

## 测试覆盖

### 单元测试
- **存储层测试**: Segment、Partition等存储组件测试
- **协议层测试**: 网络协议相关测试
- **客户端测试**: 各种客户端功能测试

### 集成测试
- **端到端测试**: 完整的消息流程测试
- **故障测试**: 各种故障场景测试
- **性能测试**: 吞吐量和延迟测试

## 当前状态

### 稳定功能
- ✅ 基础消息生产消费
- ✅ Topic和分区管理
- ✅ Consumer Group
- ✅ 事务支持
- ✅ 集群管理
- ✅ 存储引擎

### 实验性功能
- 🚧 死信队列
- 🚧 顺序消息
- 🚧 高级监控

### 待完善功能
- ⏳ 完整的监控系统
- ⏳ 管理界面
- ⏳ 更多压缩算法
- ⏳ 流处理支持

---

**最后更新**: 2024年9月22日
**版本**: v1.0.0-alpha
**维护者**: Go-Queue开发团队 