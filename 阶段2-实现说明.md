# é˜¶æ®µ2å®ç°è¯´æ˜ - Controllerå®ç°

## æ¦‚è¿°

é˜¶æ®µ2æˆåŠŸå®ç°äº†Multi-Raftæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿçš„Controlleræ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬Controller Raft Groupã€é›†ç¾¤å…ƒæ•°æ®ç®¡ç†ã€ä»¥åŠå®Œæ•´çš„Dragonboaté›†æˆã€‚

## ğŸ¯ é˜¶æ®µ2ç›®æ ‡ä¸å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

#### 1. å®Œæ•´çš„Dragonboaté›†æˆ
- **âœ… çœŸæ­£çš„Dragonboat NodeHost**: æ›¿æ¢äº†å ä½ç¬¦å®ç°ï¼Œä½¿ç”¨çœŸæ­£çš„Dragonboat v3
- **âœ… å®Œæ•´çš„Raftç®¡ç†å™¨**: å®ç°äº†StartRaftGroupã€StopRaftGroupã€SyncProposeã€SyncReadç­‰æ ¸å¿ƒAPI
- **âœ… çŠ¶æ€æœºæ¥å£**: æ­£ç¡®å®ç°äº†Dragonboatè¦æ±‚çš„IStateMachineæ¥å£
- **âœ… é…ç½®ç®¡ç†**: å®Œæ•´çš„Rafté…ç½®å‚æ•°è®¾ç½®

#### 2. Controller Raft Groupå®ç°
- **âœ… ControllerçŠ¶æ€æœº**: ç®¡ç†é›†ç¾¤å…ƒæ•°æ®çš„æ ¸å¿ƒçŠ¶æ€æœº
- **âœ… Leaderé€‰ä¸¾**: è‡ªåŠ¨çš„Controller Leaderé€‰ä¸¾å’Œè§’è‰²åˆ‡æ¢
- **âœ… å…ƒæ•°æ®ç®¡ç†**: é›†ç¾¤ã€Brokerã€Topicã€Partitionçš„å®Œæ•´å…ƒæ•°æ®ç®¡ç†
- **âœ… åˆ†åŒºåˆ†é…**: åŸºç¡€çš„Round-Robinåˆ†åŒºåˆ†é…ç®—æ³•

#### 3. é›†ç¾¤åè°ƒåŠŸèƒ½
- **âœ… Brokeræ³¨å†Œ/æ³¨é”€**: BrokeråŠ å…¥å’Œç¦»å¼€é›†ç¾¤çš„ç®¡ç†
- **âœ… å¥åº·æ£€æŸ¥**: åŸºç¡€çš„Brokerå¥åº·ç›‘æ§
- **âœ… æ•…éšœæ£€æµ‹**: æ£€æµ‹å’Œæ ‡è®°å¤±è´¥çš„Broker
- **âœ… Leaderè¿ç§»**: æ”¯æŒPartition Leaderçš„è¿ç§»

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„ç»„ä»¶

### 1. RaftManager (`internal/raft/raft_manager.go`)

**å®Œæ•´çš„Dragonboatå°è£…**ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

```go
type RaftManager struct {
    config   *RaftConfig
    dataDir  string
    nodeHost *dragonboat.NodeHost
    groups   map[uint64]*RaftGroup
    // ...
}
```

**æ ¸å¿ƒAPI**ï¼š
- `StartRaftGroup()` - å¯åŠ¨Raftç»„
- `StopRaftGroup()` - åœæ­¢Raftç»„  
- `SyncPropose()` - åŒæ­¥ææ¡ˆ
- `SyncRead()` - çº¿æ€§åŒ–è¯»å–
- `TransferLeadership()` - Leaderè½¬ç§»
- `IsLeader()` - LeaderçŠ¶æ€æŸ¥è¯¢

### 2. ControllerStateMachine (`internal/raft/controller_sm.go`)

**é›†ç¾¤å…ƒæ•°æ®ç®¡ç†çš„çŠ¶æ€æœº**ï¼Œå®ç°äº†ï¼š

```go
type ControllerStateMachine struct {
    manager  ControllerManager
    metadata *ClusterMetadata
    mu       sync.RWMutex
}
```

**æ”¯æŒçš„å‘½ä»¤**ï¼š
- `register_broker` - æ³¨å†ŒBroker
- `unregister_broker` - æ³¨é”€Broker
- `create_topic` - åˆ›å»ºTopic
- `delete_topic` - åˆ é™¤Topic
- `migrate_leader` - è¿ç§»Leader
- `update_broker_load` - æ›´æ–°è´Ÿè½½ä¿¡æ¯
- `mark_broker_failed` - æ ‡è®°Brokerå¤±è´¥

### 3. ControllerManager (`internal/broker/controller.go`)

**ControlleråŠŸèƒ½çš„æ ¸å¿ƒç®¡ç†å™¨**ï¼ŒåŒ…æ‹¬ï¼š

```go
type ControllerManager struct {
    broker          *Broker
    stateMachine    *ControllerStateMachine
    healthChecker   *HealthChecker
    leaderScheduler *LeaderScheduler
    loadMonitor     *LoadMonitor
    failureDetector *FailureDetector
    // ...
}
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- Leader/Followerè§’è‰²ç®¡ç†
- åå°å¥åº·æ£€æŸ¥
- é›†ç¾¤å…ƒæ•°æ®æŸ¥è¯¢
- å‘½ä»¤æ‰§è¡Œå’ŒRaftææ¡ˆ

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. Dragonboaté›†æˆ
- **ç‰ˆæœ¬**: Dragonboat v3.3.8
- **çŠ¶æ€æœºæ¥å£**: æ­£ç¡®å®ç°äº†`IStateMachine`æ¥å£
- **é…ç½®**: å®Œæ•´çš„NodeHostå’ŒRafté…ç½®
- **ç”Ÿå‘½å‘¨æœŸ**: æ­£ç¡®çš„å¯åŠ¨ã€åœæ­¢ã€æ¸…ç†æµç¨‹

### 2. Controller Raft Group
- **Group ID**: å›ºå®šä½¿ç”¨ID=1ä½œä¸ºControllerç»„
- **æˆå‘˜å‘ç°**: é€šè¿‡æœåŠ¡å‘ç°è‡ªåŠ¨å‘ç°å…¶ä»–Broker
- **Leaderé€‰ä¸¾**: è‡ªåŠ¨é€‰ä¸¾Controller Leader
- **èƒŒæ™¯ä»»åŠ¡**: Leaderæ‰æ‰§è¡Œçš„å¥åº·æ£€æŸ¥ã€è´Ÿè½½ç›‘æ§ç­‰ä»»åŠ¡

### 3. å…ƒæ•°æ®ç»“æ„
```go
type ClusterMetadata struct {
    ClusterID            string
    Brokers              map[string]*BrokerInfo
    Topics               map[string]*TopicMetadata
    PartitionAssignments map[string]*PartitionAssignment
    LeaderAssignments    map[string]string
    Version              int64
    UpdateTime           time.Time
}
```

### 4. æœåŠ¡å‘ç°é›†æˆ
- æ”¯æŒå¤šç§æœåŠ¡å‘ç°åç«¯ï¼ˆmemoryã€etcdã€consulï¼‰
- è‡ªåŠ¨å‘ç°å…¶ä»–BrokerèŠ‚ç‚¹
- æ„å»ºController Raft Groupæˆå‘˜åˆ—è¡¨

## ğŸš€ å¯åŠ¨å’Œæµ‹è¯•

### 1. ç¼–è¯‘
```bash
go build -o bin/broker cmd/broker/main.go
```

### 2. å¯åŠ¨å•ä¸ªBroker
```bash
./bin/broker -config configs/broker.yaml
```

### 3. å¯åŠ¨å¤šBrokeré›†ç¾¤
```bash
# Broker 1
./bin/broker -node-id broker-1 -raft-addr localhost:63001

# Broker 2  
./bin/broker -node-id broker-2 -raft-addr localhost:63002

# Broker 3
./bin/broker -node-id broker-3 -raft-addr localhost:63003
```

## ğŸ“Š å½“å‰èƒ½åŠ›èŒƒå›´

### âœ… æ”¯æŒçš„åŠŸèƒ½
1. **é›†ç¾¤ç®¡ç†**
   - Brokeræ³¨å†Œå’Œå‘ç°
   - Controller Leaderé€‰ä¸¾
   - åŸºç¡€å¥åº·æ£€æŸ¥

2. **å…ƒæ•°æ®ç®¡ç†**
   - Topicåˆ›å»º/åˆ é™¤
   - åˆ†åŒºåˆ†é…ï¼ˆç®€åŒ–ç‰ˆï¼‰
   - Leaderä¿¡æ¯æŸ¥è¯¢

3. **Raftä¸€è‡´æ€§**
   - å®Œæ•´çš„Raftå¤åˆ¶
   - å¿«ç…§å’Œæ¢å¤
   - Leaderè½¬ç§»

### âš ï¸ é™åˆ¶
1. **ç®€åŒ–å®ç°**: ä¸ºäº†éªŒè¯æ¶æ„ï¼Œè®¸å¤šåŠŸèƒ½åšäº†ç®€åŒ–
2. **åˆ†åŒºåˆ†é…**: ç›®å‰åªå®ç°äº†åŸºç¡€çš„Round-Robinç®—æ³•
3. **æ•…éšœæ¢å¤**: æ•…éšœæ£€æµ‹å­˜åœ¨ï¼Œä½†æ¢å¤æœºåˆ¶è¿˜éœ€å®Œå–„
4. **è´Ÿè½½å‡è¡¡**: è´Ÿè½½ç›‘æ§å­˜åœ¨ï¼Œä½†é‡å¹³è¡¡é€»è¾‘éœ€è¦å®ç°

## ğŸ”œ ä¸‹ä¸€æ­¥è®¡åˆ’ (é˜¶æ®µ3)

### ä¸»è¦ç›®æ ‡
1. **Partition Raft Groups**: å®ç°æ•°æ®åˆ†åŒºçš„Raftç»„
2. **æ¶ˆæ¯å­˜å‚¨**: é›†æˆç°æœ‰çš„å­˜å‚¨å¼•æ“
3. **è¯»å†™è·¯å¾„**: å®ç°å®Œæ•´çš„æ¶ˆæ¯è¯»å†™æµç¨‹
4. **æ€§èƒ½ä¼˜åŒ–**: æ‰¹é‡å¤„ç†ã€ç¼“å­˜ç­‰ä¼˜åŒ–

### æŠ€æœ¯é‡ç‚¹
1. **åˆ†åŒºçŠ¶æ€æœº**: å®ç°æ¶ˆæ¯æ•°æ®çš„çŠ¶æ€æœº
2. **å­˜å‚¨é›†æˆ**: ä¸ç°æœ‰segmentå­˜å‚¨çš„é›†æˆ
3. **è·¯ç”±é€»è¾‘**: æ¶ˆæ¯è·¯ç”±åˆ°æ­£ç¡®çš„Partition Leader
4. **ä¸€è‡´æ€§ä¿è¯**: ç¡®ä¿æ¶ˆæ¯çš„å¼ºä¸€è‡´æ€§

## ğŸ“ ä»£ç ç»“æ„

```
internal/
â”œâ”€â”€ raft/
â”‚   â”œâ”€â”€ raft_manager.go      # Dragonboatå°è£…
â”‚   â””â”€â”€ controller_sm.go     # ControllerçŠ¶æ€æœº
â”œâ”€â”€ broker/
â”‚   â”œâ”€â”€ broker.go           # ä¸»Brokerç»“æ„
â”‚   â”œâ”€â”€ controller.go       # Controllerç®¡ç†å™¨
â”‚   â”œâ”€â”€ partition.go        # åˆ†åŒºç®¡ç†å™¨(å¾…å®Œå–„)
â”‚   â””â”€â”€ client_server.go    # å®¢æˆ·ç«¯æœåŠ¡å™¨
â””â”€â”€ discovery/
    â”œâ”€â”€ discovery.go        # æœåŠ¡å‘ç°æ¥å£
    â”œâ”€â”€ memory.go          # å†…å­˜å®ç°
    â””â”€â”€ etcd.go           # etcdå®ç°
```

## ğŸ‰ æˆå°±æ€»ç»“

é˜¶æ®µ2æˆåŠŸå»ºç«‹äº†Multi-Raftæ¶æ„çš„**æ§åˆ¶å¹³é¢**ï¼š
- âœ… å®Œæ•´çš„Dragonboaté›†æˆ
- âœ… Controller Raft Groupå®ç°
- âœ… é›†ç¾¤å…ƒæ•°æ®ç®¡ç†
- âœ… Leaderé€‰ä¸¾å’Œè§’è‰²ç®¡ç†
- âœ… åŸºç¡€çš„åˆ†å¸ƒå¼åè°ƒåŠŸèƒ½

è¿™ä¸ºä¸‹ä¸€é˜¶æ®µå®ç°**æ•°æ®å¹³é¢**ï¼ˆPartition Raft Groupså’Œæ¶ˆæ¯å­˜å‚¨ï¼‰å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚æ•´ä¸ªç³»ç»Ÿæ¶æ„å·²ç»å…·å¤‡äº†é«˜å¯ç”¨ã€å¼ºä¸€è‡´æ€§çš„æ§åˆ¶å±‚ï¼Œå¯ä»¥æ”¯æ’‘å¤§è§„æ¨¡çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤ã€‚ 