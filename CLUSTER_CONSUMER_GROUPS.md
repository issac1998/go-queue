# é›†ç¾¤æ¨¡å¼æ¶ˆè´¹è€…ç»„ (Cluster Consumer Groups)

Go Queueç°åœ¨å®Œå…¨æ”¯æŒé›†ç¾¤æ¨¡å¼ä¸‹çš„æ¶ˆè´¹è€…ç»„åŠŸèƒ½ï¼è¿™æ˜¯åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜çº§ç‰¹æ€§ï¼Œæä¾›è·¨èŠ‚ç‚¹çš„æ¶ˆè´¹è€…ç»„åè°ƒå’Œä¸€è‡´æ€§ä¿è¯ã€‚

## ğŸŒŸ ä¸»è¦ç‰¹æ€§

### é›†ç¾¤æ¨¡å¼å¢å¼º
- **Raftä¸€è‡´æ€§**: æ‰€æœ‰æ¶ˆè´¹è€…ç»„çŠ¶æ€é€šè¿‡Raftåè®®åŒæ­¥åˆ°é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹
- **Leaderåè°ƒ**: åªæœ‰é›†ç¾¤LeaderèŠ‚ç‚¹æ‰§è¡Œæ¶ˆè´¹è€…ç»„ç®¡ç†æ“ä½œ
- **æ•…éšœæ¢å¤**: èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨ä»å…¶ä»–èŠ‚ç‚¹æ¢å¤æ¶ˆè´¹è€…ç»„çŠ¶æ€
- **åˆ†å¸ƒå¼é‡å¹³è¡¡**: è·¨èŠ‚ç‚¹çš„åˆ†åŒºé‡æ–°åˆ†é…

### æ ¸å¿ƒåŠŸèƒ½
- **è·¨èŠ‚ç‚¹æ¶ˆè´¹è€…ç»„**: æ¶ˆè´¹è€…å¯ä»¥è¿æ¥åˆ°é›†ç¾¤ä¸­çš„ä»»æ„èŠ‚ç‚¹
- **ä¸€è‡´æ€§ä¿è¯**: æ¶ˆè´¹è€…ç»„çŠ¶æ€åœ¨æ‰€æœ‰èŠ‚ç‚¹é—´ä¿æŒä¸€è‡´
- **OffsetåŒæ­¥**: æ¶ˆè´¹è¿›åº¦é€šè¿‡RaftåŒæ­¥ï¼Œç¡®ä¿ä¸ä¸¢å¤±
- **è‡ªåŠ¨æ•…éšœè½¬ç§»**: LeaderèŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨é€‰æ‹©æ–°Leader

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### é›†ç¾¤ç»„ä»¶å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯å±‚                              â”‚
â”‚  GroupConsumer -> ä»»æ„BrokerèŠ‚ç‚¹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åè®®å¤„ç†å±‚                             â”‚
â”‚  HandleJoinGroupRequest (æ”¯æŒé›†ç¾¤æ¨¡å¼)                   â”‚
â”‚  HandleLeaveGroupRequest / HandleHeartbeatRequest       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  é›†ç¾¤ç®¡ç†å±‚                              â”‚
â”‚  ClusterManager.JoinConsumerGroup()                    â”‚
â”‚  ClusterManager.LeaveConsumerGroup()                   â”‚
â”‚  ClusterManager.RebalanceConsumerGroupPartitions()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  RaftçŠ¶æ€æœº                              â”‚
â”‚  ClusterStateMachine                                   â”‚
â”‚  - consumerGroups (ä¸€è‡´æ€§å­˜å‚¨)                           â”‚
â”‚  - groupOffsets (ä¸€è‡´æ€§å­˜å‚¨)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Raftåè®®                               â”‚
â”‚  è·¨èŠ‚ç‚¹åŒæ­¥ & Leaderé€‰ä¸¾                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ“ä½œç±»å‹

### æ–°å¢çš„Raftæ“ä½œ
- `OpJoinConsumerGroup (7)`: æ¶ˆè´¹è€…åŠ å…¥ç»„
- `OpLeaveConsumerGroup (8)`: æ¶ˆè´¹è€…ç¦»å¼€ç»„  
- `OpRebalancePartitions (9)`: åˆ†åŒºé‡å¹³è¡¡
- `OpCommitOffset (10)`: æäº¤æ¶ˆè´¹è¿›åº¦
- `OpHeartbeatConsumer (11)`: æ¶ˆè´¹è€…å¿ƒè·³

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨é›†ç¾¤

åˆ›å»º3ä¸ªbrokeré…ç½®æ–‡ä»¶:

**configs/broker1.json**:
```json
{
  "server": {
    "port": "9092",
    "log_file": "logs/broker1.log"
  },
  "config": {
    "data_dir": "data/broker1"
  },
  "cluster": {
    "enabled": true,
    "node_id": 1,
    "raft_address": "localhost:8091",
    "data_dir": "raft_data/node1",
    "peers": [
      {"id": 1, "address": "localhost:8091"},
      {"id": 2, "address": "localhost:8092"},
      {"id": 3, "address": "localhost:8093"}
    ]
  }
}
```

**configs/broker2.json** (ä¿®æ”¹ç«¯å£å’ŒèŠ‚ç‚¹ID):
```json
{
  "server": {
    "port": "9093",
    "log_file": "logs/broker2.log"
  },
  "config": {
    "data_dir": "data/broker2"
  },
  "cluster": {
    "enabled": true,
    "node_id": 2,
    "raft_address": "localhost:8092",
    "data_dir": "raft_data/node2",
    "peers": [
      {"id": 1, "address": "localhost:8091"},
      {"id": 2, "address": "localhost:8092"},
      {"id": 3, "address": "localhost:8093"}
    ]
  }
}
```

**configs/broker3.json** (ä¿®æ”¹ç«¯å£å’ŒèŠ‚ç‚¹ID):
```json
{
  "server": {
    "port": "9094", 
    "log_file": "logs/broker3.log"
  },
  "config": {
    "data_dir": "data/broker3"
  },
  "cluster": {
    "enabled": true,
    "node_id": 3,
    "raft_address": "localhost:8093",
    "data_dir": "raft_data/node3",
    "peers": [
      {"id": 1, "address": "localhost:8091"},
      {"id": 2, "address": "localhost:8092"},
      {"id": 3, "address": "localhost:8093"}
    ]
  }
}
```

### 2. å¯åŠ¨BrokerèŠ‚ç‚¹

```bash
# ç»ˆç«¯1
./bin/broker -config configs/broker1.json

# ç»ˆç«¯2  
./bin/broker -config configs/broker2.json

# ç»ˆç«¯3
./bin/broker -config configs/broker3.json
```

### 3. é›†ç¾¤æ¨¡å¼æ¶ˆè´¹è€…ç»„ç¤ºä¾‹

```go
package main

import (
    "log"
    "time"
    "github.com/issac1998/go-queue/client"
)

func main() {
    // è¿æ¥åˆ°é›†ç¾¤
    c := client.NewClient(client.ClientConfig{
        BrokerAddrs: []string{
            "localhost:9092", 
            "localhost:9093", 
            "localhost:9094",
        },
        Timeout: 10 * time.Second,
    })

    // åˆ›å»ºæ¶ˆè´¹è€…ç»„
    groupConsumer := client.NewGroupConsumer(c, client.GroupConsumerConfig{
        GroupID:        "my-cluster-group",
        ConsumerID:     "consumer-1",
        Topics:         []string{"my-topic"},
        SessionTimeout: 30 * time.Second,
    })

    // åŠ å…¥ç»„ (ä¼šè‡ªåŠ¨è·¯ç”±åˆ°LeaderèŠ‚ç‚¹)
    err := groupConsumer.JoinGroup()
    if err != nil {
        log.Fatalf("Failed to join group: %v", err)
    }

    // å¯åŠ¨å¿ƒè·³
    err = groupConsumer.StartHeartbeat()
    if err != nil {
        log.Fatalf("Failed to start heartbeat: %v", err)
    }

    // æ¶ˆè´¹æ¶ˆæ¯
    for {
        messages, err := groupConsumer.Subscribe()
        if err != nil {
            log.Printf("Subscribe error: %v", err)
            continue
        }

        for _, msg := range messages {
            log.Printf("Consumed: %s", string(msg.Value))
            
            // æäº¤offset (åŒæ­¥åˆ°é›†ç¾¤)
            err = groupConsumer.CommitOffset(msg.Topic, msg.Partition, msg.Offset+1)
            if err != nil {
                log.Printf("Failed to commit offset: %v", err)
            }
        }
    }
}
```

## ğŸ”„ é›†ç¾¤æ¨¡å¼vså•æœºæ¨¡å¼

### å•æœºæ¨¡å¼
- æ¶ˆè´¹è€…ç»„çŠ¶æ€å­˜å‚¨åœ¨å•ä¸ªèŠ‚ç‚¹
- èŠ‚ç‚¹æ•…éšœ = æ•°æ®ä¸¢å¤±
- ç®€å•å¿«é€Ÿï¼Œé€‚åˆå¼€å‘æµ‹è¯•

### é›†ç¾¤æ¨¡å¼  
- æ¶ˆè´¹è€…ç»„çŠ¶æ€é€šè¿‡Raftå¤åˆ¶
- è‡ªåŠ¨æ•…éšœæ¢å¤
- å¼ºä¸€è‡´æ€§ä¿è¯
- é€‚åˆç”Ÿäº§ç¯å¢ƒ

## âš¡ æ€§èƒ½ç‰¹æ€§

### ä¸€è‡´æ€§ä¿è¯
- **å¼ºä¸€è‡´æ€§**: æ‰€æœ‰æ¶ˆè´¹è€…ç»„æ“ä½œé€šè¿‡Raftè¾¾æˆä¸€è‡´
- **Leaderå†™å…¥**: åªæœ‰LeaderèŠ‚ç‚¹æ‰§è¡Œå†™æ“ä½œï¼Œé¿å…å†²çª
- **è¯»å–ä¼˜åŒ–**: å¯ä»¥ä»ä»»æ„èŠ‚ç‚¹è¯»å–çŠ¶æ€

### æ•…éšœå¤„ç†
- **èŠ‚ç‚¹æ•…éšœ**: è‡ªåŠ¨ä»å…¶ä»–èŠ‚ç‚¹æ¢å¤
- **ç½‘ç»œåˆ†åŒº**: Raftç®—æ³•ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **Leaderæ•…éšœ**: è‡ªåŠ¨é€‰ä¸¾æ–°Leaderç»§ç»­æœåŠ¡

## ğŸ“ˆ ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—ä¿¡æ¯
```bash
# æŸ¥çœ‹æ¶ˆè´¹è€…ç»„æ“ä½œæ—¥å¿—
tail -f logs/broker1.log | grep "JoinGroup\|LeaveGroup\|Heartbeat"

# æŸ¥çœ‹RaftçŠ¶æ€
tail -f logs/broker1.log | grep "raft\|cluster"
```

### çŠ¶æ€æŸ¥è¯¢
é›†ç¾¤æ¨¡å¼ä¸‹å¯ä»¥é€šè¿‡ä»»æ„èŠ‚ç‚¹æŸ¥è¯¢æ¶ˆè´¹è€…ç»„çŠ¶æ€ï¼Œæ‰€æœ‰èŠ‚ç‚¹ä¿æŒä¸€è‡´ã€‚

## ğŸš€ æœ€ä½³å®è·µ

### 1. é›†ç¾¤é…ç½®
- è‡³å°‘3ä¸ªèŠ‚ç‚¹ (æ”¯æŒ1ä¸ªèŠ‚ç‚¹æ•…éšœ)
- å¥‡æ•°ä¸ªèŠ‚ç‚¹ (é¿å…è„‘è£‚)
- åˆç†çš„å¿ƒè·³é—´éš” (å»ºè®®30s)

### 2. å®¢æˆ·ç«¯é…ç½®
- é…ç½®å¤šä¸ªbrokeråœ°å€å®ç°æ•…éšœè½¬ç§»
- åˆç†çš„è¶…æ—¶æ—¶é—´
- é€‚å½“çš„é‡è¯•æœºåˆ¶

### 3. ç›‘æ§æŒ‡æ ‡
- Raft LeaderçŠ¶æ€
- æ¶ˆè´¹è€…ç»„æ•°é‡å’ŒçŠ¶æ€
- Offsetæäº¤å»¶è¿Ÿ
- èŠ‚ç‚¹å¥åº·çŠ¶å†µ

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **"only leader can handle consumer group operations"**
   - å½“å‰èŠ‚ç‚¹ä¸æ˜¯Leaderï¼Œè¯·ç­‰å¾…Leaderé€‰ä¸¾å®Œæˆ

2. **è¿æ¥è¶…æ—¶**
   - æ£€æŸ¥é›†ç¾¤èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å¯åŠ¨
   - éªŒè¯ç½‘ç»œè¿æ¥

3. **æ¶ˆè´¹è€…ç»„æ“ä½œå¤±è´¥**
   - ç¡®è®¤é›†ç¾¤çŠ¶æ€å¥åº·
   - æ£€æŸ¥Raftæ—¥å¿—

### è°ƒè¯•å‘½ä»¤
```bash
# æ£€æŸ¥è¿›ç¨‹
ps aux | grep broker

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :909

# æŸ¥çœ‹æ•°æ®ç›®å½•
ls -la data/ raft_data/
```

## ğŸ¯ æ€»ç»“

é›†ç¾¤æ¨¡å¼æ¶ˆè´¹è€…ç»„æä¾›äº†ï¼š
- **é«˜å¯ç”¨æ€§**: èŠ‚ç‚¹æ•…éšœä¸å½±å“æœåŠ¡
- **å¼ºä¸€è‡´æ€§**: Raftåè®®ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **è‡ªåŠ¨æ¢å¤**: æ•…éšœè‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤
- **æ¨ªå‘æ‰©å±•**: æ”¯æŒæ›´å¤šæ¶ˆè´¹è€…å’Œæ›´é«˜ååé‡

è¿™ä½¿å¾—Go Queueæˆä¸ºçœŸæ­£çš„ä¼ä¸šçº§åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼ğŸ‰ 